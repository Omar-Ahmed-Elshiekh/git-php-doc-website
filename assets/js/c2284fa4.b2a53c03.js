"use strict";(self.webpackChunkdocsite=self.webpackChunkdocsite||[]).push([[411],{4301:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"Commands Implementation/add command","title":"add command","description":"The add command is used to add file contents to the index. This command updates the index using the current content found in the working tree, to prepare the content staged for the next commit.","source":"@site/docs/Commands Implementation/add command.md","sourceDirName":"Commands Implementation","slug":"/Commands Implementation/add command","permalink":"/git-php-doc-website/Commands Implementation/add command","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"cat-file command","permalink":"/git-php-doc-website/Commands Implementation/cat-file command"},"next":{"title":"ls-files command","permalink":"/git-php-doc-website/Commands Implementation/ls-files command"}}');var r=t(4848),d=t(8453);const s={},a="add command",o={},c=[{value:"Command Implementation",id:"command-implementation",level:2},{value:"Helper functions",id:"helper-functions",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,d.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"add-command",children:"add command"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.a,{href:"https://git-scm.com/docs/git-add",children:"add command"})," is used to add file contents to the index. This command updates the index using the current content found in the working tree, to prepare the content staged for the next commit."]}),"\n",(0,r.jsx)(n.p,{children:"In Git, the index, often referred to as the staging area, is a crucial component of the version control process. It serves as a middle layer between your working directory and the repository, enabling you to organize and review changes before committing them. The index is a binary file that stores a sorted list of file names, along with file metadata and pointers to the object database but in this project we'll store the data in a normal text format for simplicity."}),"\n",(0,r.jsx)(n.h2,{id:"command-implementation",children:"Command Implementation"}),"\n",(0,r.jsxs)(n.p,{children:["First, we define the function ",(0,r.jsx)(n.code,{children:"command_add($args)"}),"."]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Check if index file exists:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",metastring:'title="./index.php"',children:'if (!file_exists(".mygit/index")) {\r\n  file_put_contents(".mygit/index", \'\');\r\n}\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"If the index does not exist we create an empty index file."}),"\n"]}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsx)(n.li,{children:"Check if user input:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",metastring:'title="./index.php"',children:'if (empty($args)) {\r\n  echo "Error: No paths specified for adding\\n";\r\n  return;\r\n}\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["We check if ",(0,r.jsx)(n.code,{children:"$args"})," is empty that means the user didn't provide any input path so we print an error and return."]}),"\n"]}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsx)(n.li,{children:"Get index current content:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",metastring:'title="./index.php"',children:"$index_entries = [];\r\n$index_contents = file_get_contents('.mygit/index');\r\nif ($index_contents) {\r\n  $index_entries = array_filter(explode(\"\\n\", $index_contents));\r\n}\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["First, we create ",(0,r.jsx)(n.code,{children:"$index_entries"})," array which will contain each line of index contents."]}),"\n",(0,r.jsxs)(n.li,{children:["We get the contents of index file and save it in ",(0,r.jsx)(n.code,{children:"$index_contents"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["We check if ",(0,r.jsx)(n.code,{children:"$index_contents"})," has a value, if it does we split the ",(0,r.jsx)(n.code,{children:"$index_contents"})," string into an array and store it in ",(0,r.jsx)(n.code,{children:"$index_entries"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.ol,{start:"4",children:["\n",(0,r.jsx)(n.li,{children:"Create index mapping:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",metastring:'title="./index.php"',children:'$index = [];\r\n\r\nforeach ($index_entries as $entry) {\r\n  $parts = explode(" ", $entry);\r\n  if (count($parts) >= 4) {\r\n    $path = $parts[3];\r\n    $index[$path] = $entry;\r\n  }\r\n}\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["For each entry, each entry will look like this ex:",(0,r.jsx)(n.code,{children:"100644 blob 595a9f9dcdc6e92bd7b88be3673dd1df22ceca67 index.php"}),", we split it into 4 parts,\r\nthen we validate that parts have 4 elements, and we map each path which is at index 3 to the entire entry."]}),"\n"]}),"\n",(0,r.jsxs)(n.ol,{start:"5",children:["\n",(0,r.jsx)(n.li,{children:"Process provided paths:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",metastring:'title="./index.php"',children:"foreach ($args as $path) {\r\n  if (!file_exists($path)) {\r\n    echo \"Error: '$path' does not exist\\n\";\r\n    continue;\r\n  }\r\n\r\n  if (is_file($path)) {\r\n    add_file($path, $index);\r\n  } else if (is_dir($path)) {\r\n    add_dir($path, $index);\r\n  }\r\n}\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"For each path given in $args, the function checks if the file/directory exists. If not, it prints an error message and skips that entry."}),"\n",(0,r.jsx)(n.li,{children:"If the path points to a file, add_file() is called; if it\u2019s a directory, add_dir() is called (which we'll explain in a minute)."}),"\n"]}),"\n",(0,r.jsxs)(n.ol,{start:"6",children:["\n",(0,r.jsx)(n.li,{children:"Store new index contents:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",metastring:'title="./index.php"',children:'ksort($index);\r\n$new_content = implode("\\n", $index);\r\nif ($new_content) {\r\n  $new_content .= "\\n";\r\n}\r\n\r\nfile_put_contents(".mygit/index", $new_content);\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["In Git, the data stored in index file are sorted so we use ",(0,r.jsx)(n.a,{href:"https://www.php.net/manual/en/function.ksort.php",children:(0,r.jsx)(n.code,{children:"ksort"})})," built-in function to sort index contents before we store them."]}),"\n",(0,r.jsxs)(n.li,{children:["Then we convert the ",(0,r.jsx)(n.code,{children:"$index"})," array into a string separated with ",(0,r.jsx)(n.code,{children:"\\n"})," and check if the ",(0,r.jsx)(n.code,{children:"$new_content"})," is not empty we concatenate a ",(0,r.jsx)(n.code,{children:"\\n"})," to it for future use."]}),"\n",(0,r.jsx)(n.li,{children:"Then we store the new content into the index file."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"helper-functions",children:"Helper functions"}),"\n",(0,r.jsxs)(n.ol,{start:"7",children:["\n",(0,r.jsx)(n.li,{children:"add_file() function:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",metastring:'title="./index"',children:"function add_file($path, &$index)\r\n{\r\n  if (str_starts_with($path, './mygit'))\r\n    return;\r\n  $hash = command_hash_object([$path, 1]);\r\n  $mode = '100644';\r\n  $type = 'blob';\r\n  $entry = \"$mode $type $hash $path\";\r\n  $index[$path] = $entry;\r\n}\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["We pass the ",(0,r.jsx)(n.code,{children:"$path"})," of a file and reference to index array ",(0,r.jsx)(n.code,{children:"&$index"})," so we make changes to current index not just to take a copy from it."]}),"\n",(0,r.jsx)(n.li,{children:"We ingonre the MyGit directory to prevent tracking repo metadata."}),"\n",(0,r.jsxs)(n.li,{children:["We compute the hash of the object using the ",(0,r.jsx)(n.code,{children:"command_hash_object([$path, 1])"})," function we created earlier by giving it the ",(0,r.jsx)(n.code,{children:"$path"})," and 1 to write enable."]}),"\n",(0,r.jsxs)(n.li,{children:["Then save the entry in the format ",(0,r.jsx)(n.code,{children:"<mode> <type> <hash> <path>"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.ol,{start:"8",children:["\n",(0,r.jsx)(n.li,{children:"add_dir() function:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",metastring:'title="./index.php"',children:"function add_dir($dir, &$index)\r\n{\r\n  $items = scandir($dir);\r\n\r\n  foreach ($items as $item) {\r\n    if ($item === '.' || $item === '..' || $item === '.mygit') {\r\n      continue;\r\n    }\r\n\r\n    $path = $dir === '.' ? $item : \"$dir/$item\";\r\n\r\n    if (is_file($path)) {\r\n      add_file($path, $index);\r\n    } else if (is_dir($path)) {\r\n      add_dir($path, $index);\r\n    }\r\n  }\r\n}\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Uses scandir($dir) to retrieve all files and subdirectories."}),"\n",(0,r.jsx)(n.li,{children:"Ignores . (current directory), .. (parent directory), .mygit, and .git directories."}),"\n",(0,r.jsx)(n.li,{children:"Calls add_file() for files."}),"\n",(0,r.jsx)(n.li,{children:"Calls itself (add_dir()) recursively for subdirectories."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Full code for this section:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",metastring:'title="./index.php"',children:'function command_add($args)\r\n{\r\n  if (!file_exists(".mygit/index")) {\r\n    file_put_contents(".mygit/index", \'\');\r\n  }\r\n\r\n  if (empty($args)) {\r\n    echo "Error: No paths specified for adding\\n";\r\n    return;\r\n  }\r\n\r\n  $index_entries = [];\r\n  $index_contents = file_get_contents(\'.mygit/index\');\r\n  if ($index_contents) {\r\n    $index_entries = array_filter(explode("\\n", $index_contents));\r\n  }\r\n\r\n  $index = [];\r\n\r\n  foreach ($index_entries as $entry) {\r\n    $parts = explode(" ", $entry);\r\n    if (count($parts) >= 4) {\r\n      $path = $parts[3];\r\n      $index[$path] = $entry;\r\n    }\r\n  }\r\n\r\n  foreach ($args as $path) {\r\n    if (!file_exists($path)) {\r\n      echo "Error: \'$path\' does not exist\\n";\r\n      continue;\r\n    }\r\n\r\n    if (is_file($path)) {\r\n      add_file($path, $index);\r\n    } else if (is_dir($path)) {\r\n      add_dir($path, $index);\r\n    }\r\n  }\r\n\r\n  ksort($index);\r\n  $new_content = implode("\\n", $index);\r\n  if ($new_content) {\r\n    $new_content .= "\\n";\r\n  }\r\n\r\n  file_put_contents(".mygit/index", $new_content);\r\n\r\n}\r\n\r\nfunction add_file($path, &$index)\r\n{\r\n  if (str_starts_with($path, \'./mygit\'))\r\n    return;\r\n  $hash = command_hash_object([$path, 1]);\r\n  $mode = \'100644\';\r\n  $type = \'blob\';\r\n  $entry = "$mode $type $hash $path";\r\n  $index[$path] = $entry;\r\n}\r\n\r\nfunction add_dir($dir, &$index)\r\n{\r\n  $items = scandir($dir);\r\n\r\n  foreach ($items as $item) {\r\n    if ($item === \'.\' || $item === \'..\' || $item === \'.mygit\') {\r\n      continue;\r\n    }\r\n\r\n    $path = $dir === \'.\' ? $item : "$dir/$item";\r\n\r\n    if (is_file($path)) {\r\n      add_file($path, $index);\r\n    } else if (is_dir($path)) {\r\n      add_dir($path, $index);\r\n    }\r\n  }\r\n}\n'})})]})}function h(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>a});var i=t(6540);const r={},d=i.createContext(r);function s(e){const n=i.useContext(d);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),i.createElement(d.Provider,{value:n},e.children)}}}]);