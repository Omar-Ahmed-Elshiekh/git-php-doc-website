"use strict";(self.webpackChunkdocsite=self.webpackChunkdocsite||[]).push([[217],{7251:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>d,frontMatter:()=>c,metadata:()=>r,toc:()=>m});const r=JSON.parse('{"id":"Commands Implementation/commit command","title":"commit command","description":"The commit command is used to record changes to the repository by creating a new commit object containing the current contents of the index and the given log message describing the changes.","source":"@site/docs/Commands Implementation/commit command.md","sourceDirName":"Commands Implementation","slug":"/Commands Implementation/commit command","permalink":"/git-php-doc-website/Commands Implementation/commit command","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"ls-tree command","permalink":"/git-php-doc-website/Commands Implementation/ls-tree command"},"next":{"title":"log command","permalink":"/git-php-doc-website/Commands Implementation/log command"}}');var i=t(4848),s=t(8453);const c={},a="commit command",o={},m=[{value:"Command implementation",id:"command-implementation",level:3}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"commit-command",children:"commit command"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.a,{href:"https://git-scm.com/docs/git-commit",children:"commit command"})," is used to record changes to the repository by creating a new commit object containing the current contents of the index and the given log message describing the changes."]}),"\n",(0,i.jsx)(n.p,{children:"Each commit object includes:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"A snapshot (tree object) of the current state of the repository."}),"\n",(0,i.jsx)(n.li,{children:"A reference to the parent commit (if any)."}),"\n",(0,i.jsx)(n.li,{children:"Metadata (author, timestamp, commit message)."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"command-implementation",children:"Command implementation"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Validate input arguments:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",metastring:'title="./index.php"',children:'if (!isset($args[0]) || $args[0] !== \'-m\' || !isset($args[1]) || trim($args[1]) === "") {\r\n  echo "Error: Please provide a commit message using -m flag\\n";\r\n  return;\r\n}\r\n\r\n$msg = $args[1];\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["First, we validate that the ",(0,i.jsx)(n.code,{children:"-m"})," flag (which stands for message) and the commit message are provided and not empty."]}),"\n",(0,i.jsxs)(n.li,{children:["Then we store our message in ",(0,i.jsx)(n.code,{children:"$msg"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:"Create a tree object (snapshot of the working directory):"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",metastring:'title="./index.php"',children:'  $tree_hash = command_write_tree();\r\n  if (!$tree_hash) {\r\n    echo "Error: Nothing to commit\\n";\r\n    return;\r\n  }\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["We create a new tree object from the current index using the ",(0,i.jsx)(n.code,{children:"command_write_tree()"})," function that we created earlier."]}),"\n",(0,i.jsx)(n.li,{children:"Then we validate that it is not empty."}),"\n"]}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:"Determine the parent commit (if any):"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",metastring:'title="./index.php"',children:'$parent_hash = null;\r\nif (file_exists(".mygit/HEAD")) {\r\n  $head_content = trim(file_get_contents(".mygit/HEAD"));\r\n  if(str_starts_with($head_content,"ref: ")){\r\n    $ref = substr($head_content, 5);\r\n    if (file_exists(".mygit/" . $ref)) {\r\n      $parent_hash = trim(file_get_contents(".mygit/" . $ref));\r\n    }\r\n  }\r\n}\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Checks if ",(0,i.jsx)(n.code,{children:".mygit/HEAD"})," exists (which stores the current branch reference)."]}),"\n",(0,i.jsxs)(n.li,{children:["If ",(0,i.jsx)(n.code,{children:".mygit/HEAD"})," contains a reference (",(0,i.jsx)(n.code,{children:"ref: refs/heads/main"}),"), it extracts the branch name (main) and reads the latest commit hash from ",(0,i.jsx)(n.code,{children:".mygit/refs/heads/main"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["If this file exists, it stores the commit hash as ",(0,i.jsx)(n.code,{children:"$parent_hash"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.ol,{start:"4",children:["\n",(0,i.jsx)(n.li,{children:"Construct commit object data:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",metastring:'title="./index.php"',children:'$author = "John Doe <john@example.com>";\r\n$timestamp = time();\r\n\r\n$commit_content = "tree " . $tree_hash . "\\n";\r\nif ($parent_hash) {\r\n  $commit_content .= "parent " . $parent_hash . "\\n";\r\n}\r\n$commit_content .= "author " . $author . " " . $timestamp . "\\n";\r\n$commit_content .= "committer " . $author . " " . $timestamp . "\\n";\r\n$commit_content .= "message " . $msg . "\\n";\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Defines the commit author, here we hardcoded it for simplicity."}),"\n",(0,i.jsx)(n.li,{children:"Get the current timestamp (commit time)."}),"\n",(0,i.jsxs)(n.li,{children:["Start constructing the commit content by concatenating:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Tree hash."}),"\n",(0,i.jsx)(n.li,{children:"Parent commit hash (if any)."}),"\n",(0,i.jsx)(n.li,{children:"Author with timestamp."}),"\n",(0,i.jsx)(n.li,{children:"Committer with timestamp."}),"\n",(0,i.jsx)(n.li,{children:"Commit message."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsx)(n.p,{children:"Committer and Author can be different"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The final commit format will be like this:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-text",metastring:'title="example"',children:"tree 9daeafb9864cf43055ae93beb0afd6c7d144bfa4\r\nparent e69de29bb2d1d6434b8b29ae775ad8c2e48c5391\r\nauthor John Doe <john@example.com> 1707395265\r\ncommitter John Doe <john@example.com> 1707395265\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsx)(n.p,{children:"In real Git, you cannot create multiple commits with the same index content because Git verifies whether the working directory has changed since the last commit. This is done using metadata stored in the index file.\r\nHowever, in this simplified implementation, we only check if the tree hash is empty, not if it has already been committed. And because we use time() for the commit timestamp, a new commit is always created, even if no changes were made."})}),"\n",(0,i.jsxs)(n.ol,{start:"5",children:["\n",(0,i.jsx)(n.li,{children:"Add a commit object header:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",metastring:'title="./index.php"',children:'$header = "commit " . strlen($commit_content) . "\\0";\r\n$full_content = $header . $commit_content;\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"As we have done before, we prepare commit object format."}),"\n"]}),"\n",(0,i.jsxs)(n.ol,{start:"6",children:["\n",(0,i.jsx)(n.li,{children:"Compute the commit hash:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",metastring:'title="./index.php"',children:"$hash = sha1($full_content);\r\n$compressed = gzcompress($full_content);\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Compute the commit hash and compress its content."}),"\n"]}),"\n",(0,i.jsxs)(n.ol,{start:"7",children:["\n",(0,i.jsx)(n.li,{children:"Store the commit object:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",metastring:'title="./index.php"',children:'$dir = ".mygit/objects/" . substr($hash, 0, 2);\r\nif (!is_dir($dir)) {\r\n  mkdir($dir, 0777, true);\r\n}\r\n\r\n$path = $dir . "/" . substr($hash, 2);\r\nfile_put_contents($path, $compressed);\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["We create our directory path ",(0,i.jsx)(n.code,{children:"$dir"})," by concatenating ",(0,i.jsx)(n.code,{children:"'.mygit/objects/'"})," with the first two characters in ",(0,i.jsx)(n.code,{children:"$hash"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["If the path ",(0,i.jsx)(n.code,{children:"$dir"})," didn't exist we make a new directory using ",(0,i.jsx)(n.code,{children:"mkdir()"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["We create our file path ",(0,i.jsx)(n.code,{children:"$path"})," by concatenating ",(0,i.jsx)(n.code,{children:"$dir"})," path with ",(0,i.jsx)(n.code,{children:"/"})," and the rest of the file hash. Then we save the compressed content into our file."]}),"\n"]}),"\n",(0,i.jsxs)(n.ol,{start:"8",children:["\n",(0,i.jsx)(n.li,{children:"Update the branch reference (HEAD):"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",metastring:'title="./index.php"',children:'if (!is_dir(".mygit/refs/heads")) {\r\n  mkdir(".mygit/refs/heads", 0777, true);\r\n}\r\n\r\nfile_put_contents(\'.mygit/refs/heads/main\', $hash);\r\n\r\necho "Created commit " . $hash . "\\n";\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Ensures that ",(0,i.jsx)(n.code,{children:".mygit/refs/heads/"})," exists."]}),"\n",(0,i.jsxs)(n.li,{children:["Updates ",(0,i.jsx)(n.code,{children:".mygit/refs/heads/main"})," to point to the new commit hash, marking it as the latest commit."]}),"\n",(0,i.jsx)(n.li,{children:"Print the commit hash to the user."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Full code for this section:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",metastring:'title="./index.php"',children:'function command_commit($args)\r\n{\r\n  if (!isset($args[0]) || $args[0] !== \'-m\' || !isset($args[1]) || trim($args[1]) === "") {\r\n    echo "Error: Please provide a commit message using -m flag\\n";\r\n    return;\r\n  }\r\n\r\n  $msg = $args[1];\r\n\r\n  $tree_hash = command_write_tree();\r\n  if (!$tree_hash) {\r\n    echo "Error: Nothing to commit\\n";\r\n    return;\r\n  }\r\n\r\n  $parent_hash = null;\r\n  if (file_exists(".mygit/HEAD")) {\r\n    $head_content = trim(file_get_contents(".mygit/HEAD"));\r\n    if(str_starts_with($head_content,"ref: ")){\r\n      $ref = substr($head_content, 5);\r\n      if (file_exists(".mygit/" . $ref)) {\r\n        $parent_hash = trim(file_get_contents(".mygit/" . $ref));\r\n      }\r\n    }\r\n  }\r\n\r\n  $author = "John Doe <john@example.com>";\r\n  $timestamp = time();\r\n\r\n  $commit_content = "tree " . $tree_hash . "\\n";\r\n  if ($parent_hash) {\r\n    $commit_content .= "parent " . $parent_hash . "\\n";\r\n  }\r\n  $commit_content .= "author " . $author . " " . $timestamp . "\\n";\r\n  $commit_content .= "committer " . $author . " " . $timestamp . "\\n";\r\n  $commit_content .= "message " . $msg . "\\n";\r\n\r\n  $header = "commit " . strlen($commit_content) . "\\0";\r\n  $full_content = $header . $commit_content;\r\n\r\n  $hash = sha1($full_content);\r\n  $compressed = gzcompress($full_content);\r\n\r\n  $dir = ".mygit/objects/" . substr($hash, 0, 2);\r\n  if (!is_dir($dir)) {\r\n    mkdir($dir, 0777, true);\r\n  }\r\n\r\n  $path = $dir . "/" . substr($hash, 2);\r\n  file_put_contents($path, $compressed);\r\n\r\n  if (!is_dir(".mygit/refs/heads")) {\r\n    mkdir(".mygit/refs/heads", 0777, true);\r\n  }\r\n\r\n  file_put_contents(\'.mygit/refs/heads/main\', $hash);\r\n\r\n  echo "Created commit " . $hash . "\\n";\r\n}\n'})})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>c,x:()=>a});var r=t(6540);const i={},s=r.createContext(i);function c(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);